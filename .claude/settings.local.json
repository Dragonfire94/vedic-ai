{
  "permissions": {
    "allow": [
      "Bash(git add:*)",
      "Bash(git commit:*)",
      "Bash(git push:*)",
      "Bash(node -e:*)",
      "Bash(wc:*)",
      "Bash(ls:*)",
      "Bash(cd:*)",
      "Bash(python3:*)",
      "Bash(cd /c/dev/vedic-ai && python -c \"\nimport sys, io\nsys.stdout = io.TextIOWrapper\\(sys.stdout.buffer, encoding='utf-8'\\)\n\nfrom backend.pdf_service import _KO_STRUCTURAL_LABEL_RE, _KO_CHAPTER_CLOSING_RE, _KO_CHAPTER_NAV_RE\n\nlabel_cases = [\n    \\('중심 주제: 추진력과 감수성의 공존.', '추진력과 감수성의 공존.'\\),\n    \\('내적 줄다리기: 빠른 실행 vs. 회복의 부족.', '빠른 실행 vs. 회복의 부족.'\\),\n    \\('전략 제안: 속도를 부분적으로 조절하면서 우선순위를 재정비하세요.', '속도를 부분적으로 조절하면서 우선순위를 재정비하세요.'\\),\n    \\('전략 제안\\(최종\\): 우선 회복 기반 세 가지를 정하고 12주 동안 매주 점검하세요.', '우선 회복 기반 세 가지를 정하고 12주 동안 매주 점검하세요.'\\),\n    \\('경고: 지금 이 안정성 저하를 방치하면, 복구 비용이 훨씬 커질 수 있습니다.', '지금 이 안정성 저하를 방치하면, 복구 비용이 훨씬 커질 수 있습니다.'\\),\n    \\('한 문장 경고: 이 부분을 방치하면 같은 패턴이 반복됩니다.', '이 부분을 방치하면 같은 패턴이 반복됩니다.'\\),\n]\nprint\\('=== LABEL PATTERNS ==='\\)\nall_ok = True\nfor line, expected in label_cases:\n    m = _KO_STRUCTURAL_LABEL_RE.match\\(line\\)\n    if m:\n        got = m.group\\(2\\).strip\\(\\)\n        ok = \\(got == expected\\)\n        if not ok: all_ok = False\n        print\\(f'  [OK={ok}] [{m.group\\(1\\)}] -> \\\\\"{got[:50]}\\\\\"'\\)\n    else:\n        all_ok = False\n        print\\(f'  [MISS] \\\\\"{line[:60]}\\\\\"'\\)\n\nclosing_cases = [\n    \\('이 행동 리스크가 당신의 실행력과 결과 반복에 직접 연결됩니다.', True\\),\n    \\('이 카르마적 패턴이 당신의 성장과 반복 결과를 구조적으로 규정합니다.', True\\),\n    \\('이 안정성의 수준이 당신의 일상적 결정과 실패 복구 속도를 직접 만들어냅니다.', True\\),\n    \\('이 종합적 구조가 당신의 일상 선택과 장기 결과를 직접 규정합니다.', True\\),\n    \\('이 자신감의 구조가 당신의 다음 선택과 리스크 수용에 곧장 영향을 미칩니다.', True\\),\n    \\('당신의 흐름은 이 구조가 실질적 선택과 행동 패턴으로 이어집니다.', True\\),\n    \\('당신은 실행 직후의 피로를 자주 경험합니다.', False\\),   # 일반 문장 - 통과해야함\n    \\('바다 위에서 속도를 올리는 배의 시점', False\\),          # 메타포 제목 - 통과해야함\n]\nprint\\('\\\\n=== CLOSING FORMULA ==='\\)\nfor line, should_match in closing_cases:\n    m = _KO_CHAPTER_CLOSING_RE.match\\(line\\)\n    matched = bool\\(m\\)\n    ok = \\(matched == should_match\\)\n    if not ok: all_ok = False\n    label = 'suppressed' if matched else 'kept'\n    print\\(f'  [OK={ok}] {label}: \\\\\"{line[:60]}\\\\\"'\\)\n\nnav_cases = [\n    \\('Chapter 1 - Executive: 당신이라는 사람의 흐름', True\\),\n    \\('Chapter 2 \\\\u2014 Purushartha / \\\\uc0b6\\\\uc758 \\\\ubc29\\\\ud5a5: \\\\ub2e4\\\\ub974\\\\ub9c8 \\\\uc911\\\\uc2ec', True\\),\n    \\('Chapter 15 \\\\u2014 Final Summary: \\\\ud1b5\\\\ud569\\\\uacfc \\\\uadf8\\\\ub9bc\\\\uc790', True\\),\n    \\('\\\\ubc14\\\\ub2e4 \\\\uc704\\\\uc5d0\\\\uc11c \\\\uc18d\\\\ub3c4\\\\ub97c \\\\uc62c\\\\ub9ac\\\\ub294 \\\\ubc30\\\\uc758 \\\\uc2dc\\\\uc810', False\\),\n]\nprint\\('\\\\n=== CHAPTER NAV ==='\\)\nfor line, should_match in nav_cases:\n    m = _KO_CHAPTER_NAV_RE.match\\(line\\)\n    matched = bool\\(m\\)\n    ok = \\(matched == should_match\\)\n    if not ok: all_ok = False\n    label = 'suppressed' if matched else 'kept'\n    print\\(f'  [OK={ok}] {label}: \\\\\"{line[:60]}\\\\\"'\\)\n\nprint\\(f'\\\\nALL PATTERNS: {\\\\\"PASS\\\\\" if all_ok else \\\\\"FAIL\\\\\"}'\\)\" 2>&1)",
      "Bash(cd /c/dev/vedic-ai && python -c \"\nimport sys, io, json\nsys.stdout = io.TextIOWrapper\\(sys.stdout.buffer, encoding='utf-8'\\)\n\n# 기존 live 리포트의 polished_reading_text를 가져와서 parse_markdown_to_flowables 통과 전후 비교\nsample_text = '''### 읽기 전에\n이 보고서는 당신을 평가하는 보고서가 아닙니다.\n\nChapter 1 — Executive: 당신이라는 사람의 흐름\n\n### 바다 위에서 속도를 올리는 배의 시점\n\n당신은 한 번 마음이 움직이면 빠르게 실행으로 옮기는 편입니다.\n\n당신은 실행 직후의 피로를 자주 경험합니다.\n\n중심 주제: 추진력과 감수성의 공존.\n내적 줄다리기: 빠른 실행 vs. 회복의 부족.\n지치기 쉬운 패턴: 성공 직후 무기력이나 감정적 단절.\n지금 흐름의 초점: 덜 소모되는 선택을 먼저 찾는 것.\n전략 제안: 속도를 부분적으로 조절하면서 우선순위를 재정비하세요.\n이 행동 리스크가 당신의 실행력과 결과 반복에 직접 연결됩니다.\n\nChapter 5 — Karmic Patterns: 반복 교정의 힘\n\n### 촘촘한 자수의 자리\n\n변화는 한 번의 대폭발이 아니라 반복적 교정에서 옵니다.\n\n경고: 지금 이 안정성 저하를 방치하면, 복구 비용이 훨씬 커질 수 있습니다.\n전략 제안\\(최종\\): 우선 회복 기반 세 가지를 정하고, 12주 동안 매주 점검하세요.\n이 카르마적 패턴이 당신의 성장과 반복 결과를 구조적으로 규정합니다.\n'''\n\nfrom backend.pdf_service import _KO_STRUCTURAL_LABEL_RE, _KO_CHAPTER_CLOSING_RE, _KO_CHAPTER_NAV_RE\n\nprint\\('=== 처리 결과 \\(suppressed/kept\\) ==='\\)\nfor line in sample_text.split\\('\\\\n'\\):\n    stripped = line.strip\\(\\)\n    if not stripped:\n        continue\n    if _KO_CHAPTER_NAV_RE.match\\(stripped\\):\n        print\\(f'  [SUPPRESSED-nav]  {stripped}'\\)\n    elif _KO_CHAPTER_CLOSING_RE.match\\(stripped\\):\n        print\\(f'  [SUPPRESSED-close] {stripped}'\\)\n    else:\n        m = _KO_STRUCTURAL_LABEL_RE.match\\(stripped\\)\n        if m:\n            content = m.group\\(2\\).strip\\(\\)\n            print\\(f'  [LABEL->body]     {stripped[:30]}... => \\\\\"{content[:40]}\\\\\"'\\)\n        else:\n            print\\(f'  [KEPT]            {stripped[:60]}'\\)\n\" 2>&1)",
      "Bash(cd /c/dev/vedic-ai && python -c \"\nimport sys, io, json, asyncio\nsys.stdout = io.TextIOWrapper\\(sys.stdout.buffer, encoding='utf-8'\\)\n\n# 기존 live 리포트와 동일한 파라미터로 PDF 생성\nfrom backend.pdf_service import init_fonts, generate_pdf_report\nfrom backend.main import \\(\n    resolve_pdf_narrative_content, build_report_payload,\n    build_structural_summary\n\\)\nfrom backend.astro_engine import compute_chart\n\ninit_fonts\\(\\)\n\n# live 리포트와 동일한 출생 정보\nchart = compute_chart\\(\n    year=1991, month=11, day=19,\n    hour=14.5, lat=37.5665, lon=126.9780,\n    house_system='W'\n\\)\n\n# 기존 ai_reading.json에서 polished text 로드 \\(가장 최근 golden sample\\)\nwith open\\('logs/golden_samples/01_highest_stability/ai_reading.json', encoding='utf-8'\\) as f:\n    ai_data = json.load\\(f\\)\n\n# polished_text를 주입하기 위해 ai_reading dict 구성\nai_reading = {\n    'polished_text': ai_data.get\\('ai_text', ''\\),\n    'chart_hash': 'test_a3',\n    'language': 'ko',\n}\n\npdf_bytes = generate_pdf_report\\(\n    chart=chart,\n    ai_reading=ai_reading,\n    year=1991, month=11, day=19,\n    hour=14.5, lat=37.5665, lon=126.9780,\n    house_system='W',\n    include_d9=1,\n    language='ko',\n    resolve_pdf_narrative_content_fn=resolve_pdf_narrative_content,\n    build_report_payload_fn=build_report_payload,\n    build_structural_summary_fn=build_structural_summary,\n\\)\n\nout_path = 'logs/pdf_quality_check/sample_report_a3_test.pdf'\nwith open\\(out_path, 'wb'\\) as f:\n    f.write\\(pdf_bytes\\)\nprint\\(f'PDF generated: {out_path} \\({len\\(pdf_bytes\\)//1024}KB\\)'\\)\n\" 2>&1)",
      "Bash(cd /c/dev/vedic-ai && python -c \"\nimport sys, io, json\nsys.stdout = io.TextIOWrapper\\(sys.stdout.buffer, encoding='utf-8'\\)\n\nfrom backend.pdf_service import init_fonts, generate_pdf_report\nfrom backend.main import \\(\n    _resolve_pdf_narrative_content, _build_report_payload,\n    _build_structural_summary\n\\)\nfrom backend.astro_engine import compute_chart\n\ninit_fonts\\(\\)\n\nchart = compute_chart\\(\n    year=1991, month=11, day=19,\n    hour=14.5, lat=37.5665, lon=126.9780,\n    house_system='W'\n\\)\n\nwith open\\('logs/golden_samples/01_highest_stability/ai_reading.json', encoding='utf-8'\\) as f:\n    ai_data = json.load\\(f\\)\n\nai_reading = {\n    'polished_text': ai_data.get\\('ai_text', ''\\),\n    'chart_hash': 'test_a3',\n    'language': 'ko',\n}\n\npdf_bytes = generate_pdf_report\\(\n    chart=chart,\n    ai_reading=ai_reading,\n    year=1991, month=11, day=19,\n    hour=14.5, lat=37.5665, lon=126.9780,\n    house_system='W',\n    include_d9=1,\n    language='ko',\n    resolve_pdf_narrative_content_fn=_resolve_pdf_narrative_content,\n    build_report_payload_fn=_build_report_payload,\n    build_structural_summary_fn=_build_structural_summary,\n\\)\n\nout_path = 'logs/pdf_quality_check/sample_report_a3_test.pdf'\nwith open\\(out_path, 'wb'\\) as f:\n    f.write\\(pdf_bytes\\)\nprint\\(f'PDF generated: {out_path} \\({len\\(pdf_bytes\\)//1024}KB\\)'\\)\n\" 2>&1)",
      "Bash(tail:*)",
      "Bash(cd /c/dev/vedic-ai && python -c \"\nimport sys, io, json\nsys.stdout = io.TextIOWrapper\\(sys.stdout.buffer, encoding='utf-8'\\)\n\nfrom backend.pdf_service import init_fonts, generate_pdf_report\nfrom backend.main import _resolve_pdf_narrative_content, build_report_payload, build_structural_summary\nfrom backend.astro_engine import compute_chart\n\ninit_fonts\\(\\)\n\nchart = compute_chart\\(\n    year=1991, month=11, day=19,\n    hour=14.5, lat=37.5665, lon=126.9780,\n    house_system='W'\n\\)\n\nwith open\\('logs/golden_samples/01_highest_stability/ai_reading.json', encoding='utf-8'\\) as f:\n    ai_data = json.load\\(f\\)\n\nai_reading = {\n    'polished_text': ai_data.get\\('ai_text', ''\\),\n    'chart_hash': 'test_a3',\n    'language': 'ko',\n}\n\npdf_bytes = generate_pdf_report\\(\n    chart=chart,\n    ai_reading=ai_reading,\n    year=1991, month=11, day=19,\n    hour=14.5, lat=37.5665, lon=126.9780,\n    house_system='W',\n    include_d9=1,\n    language='ko',\n    resolve_pdf_narrative_content_fn=_resolve_pdf_narrative_content,\n    build_report_payload_fn=build_report_payload,\n    build_structural_summary_fn=build_structural_summary,\n\\)\n\nout_path = 'logs/pdf_quality_check/sample_report_a3_test.pdf'\nwith open\\(out_path, 'wb'\\) as f:\n    f.write\\(pdf_bytes\\)\nprint\\(f'PDF generated: {out_path} \\({len\\(pdf_bytes\\)//1024}KB\\)'\\)\n\" 2>&1)",
      "Bash(cd /c/dev/vedic-ai && python -c \"\nimport sys, io, json\nsys.stdout = io.TextIOWrapper\\(sys.stdout.buffer, encoding='utf-8'\\)\n\n# FastAPI 앱에 직접 HTTP 요청으로 PDF 생성 \\(가장 안전한 방법\\)\nfrom fastapi.testclient import TestClient\nfrom backend.main import app\n\nclient = TestClient\\(app\\)\nresp = client.post\\('/generate_pdf', json={\n    'year': 1991, 'month': 11, 'day': 19,\n    'hour': 14.5, 'lat': 37.5665, 'lon': 126.9780,\n    'house_system': 'W',\n    'language': 'ko',\n    'include_d9': 0,\n}\\)\nprint\\(f'Status: {resp.status_code}'\\)\nif resp.status_code == 200:\n    out = 'logs/pdf_quality_check/sample_report_a3_test.pdf'\n    with open\\(out, 'wb'\\) as f:\n        f.write\\(resp.content\\)\n    print\\(f'PDF saved: {out} \\({len\\(resp.content\\)//1024}KB\\)'\\)\nelse:\n    print\\(resp.text[:500]\\)\n\" 2>&1)",
      "Bash(cd /c/dev/vedic-ai && python -c \"\nimport sys, io, json\nsys.stdout = io.TextIOWrapper\\(sys.stdout.buffer, encoding='utf-8'\\)\n\nfrom fastapi.testclient import TestClient\nfrom backend.main import app\n\nclient = TestClient\\(app\\)\nresp = client.post\\('/pdf', json={\n    'year': 1991, 'month': 11, 'day': 19,\n    'hour': 14.5, 'lat': 37.5665, 'lon': 126.9780,\n    'house_system': 'W',\n    'language': 'ko',\n    'include_d9': 0,\n}\\)\nprint\\(f'Status: {resp.status_code}'\\)\nif resp.status_code == 200:\n    out = 'logs/pdf_quality_check/sample_report_a3_test.pdf'\n    with open\\(out, 'wb'\\) as f:\n        f.write\\(resp.content\\)\n    print\\(f'PDF saved: {out} \\({len\\(resp.content\\)//1024}KB\\)'\\)\nelse:\n    print\\(resp.text[:500]\\)\n\" 2>&1)",
      "Bash(cd /c/dev/vedic-ai && python -c \"\nimport sys, io, json\nsys.stdout = io.TextIOWrapper\\(sys.stdout.buffer, encoding='utf-8'\\)\n\nfrom fastapi.testclient import TestClient\nfrom backend.main import app\n\nclient = TestClient\\(app\\)\nparams = {\n    'year': 1991, 'month': 11, 'day': 19,\n    'hour': 14.5, 'lat': 37.5665, 'lon': 126.9780,\n    'house_system': 'W',\n    'language': 'ko',\n    'include_d9': 0,\n}\nresp = client.get\\('/pdf', params=params\\)\nprint\\(f'Status: {resp.status_code}'\\)\nif resp.status_code == 200:\n    out = 'logs/pdf_quality_check/sample_report_a3_test.pdf'\n    with open\\(out, 'wb'\\) as f:\n        f.write\\(resp.content\\)\n    print\\(f'PDF saved: {out} \\({len\\(resp.content\\)//1024}KB\\)'\\)\nelse:\n    print\\(resp.text[:500]\\)\n\" 2>&1)"
    ]
  }
}
